<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte de Incidencias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/reportes.css}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4 text-center">Reporte de Incidencias</h2>
    <!-- Filtros -->
    <form method="get" th:action="@{/reportes}" class="row g-3 mb-4">
        <div class="col-md-4">
            <label class="form-label">Equipo</label>
            <select class="form-control" name="equipoId">
                <option value="">Todos</option>
                <option th:each="equipo : ${equipos}" th:value="${equipo.id}" th:text="${equipo.nombre}"></option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Tipo</label>
            <select class="form-control" name="tipo">
                <option value="">Todos</option>
                <option th:each="tipo : ${tipos}" th:value="${tipo}" th:text="${tipo}"></option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Ubicación</label>
            <select class="form-control" name="ubicacion">
                <option value="">Todas</option>
                <option th:each="ubicacion : ${ubicaciones}" th:value="${ubicacion}" th:text="${ubicacion}"></option>
            </select>
        </div>
        <div class="col-12 text-center">
            <button type="submit" class="btn btn-primary">Filtrar</button>
        </div>
    </form>
    <div id="reporte-content">
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Descripción</th>
                    <th>Estado Equipo</th>
                    <th>Nombre Equipo</th>
                    <th>Tipo</th>
                    <th>Ubicación</th>
                    <th>Fecha Apertura</th>
                    <th>Fecha Cierre</th>
                    <th>Usuario ID</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="incidencia : ${incidencias}">
                    <td th:text="${incidencia.id}"></td>
                    <td th:text="${incidencia.descripcion}"></td>
                    <td th:text="${incidencia.estadoEquipo}"></td>
                    <td th:text="${incidencia.equipo.nombre}"></td>
                    <td th:text="${incidencia.equipo.tipo}"></td>
                    <td th:text="${incidencia.equipo.ubicacion}"></td>
                    <td>
                        <span th:if="${incidencia.fechaApertura != null}"
                              th:text="${#temporals.format(incidencia.fechaApertura, 'yyyy-MM-dd')}"></span>
                    </td>
                    <td>
                        <span th:if="${incidencia.fechaCierre != null}"
                              th:text="${#temporals.format(incidencia.fechaCierre, 'yyyy-MM-dd')}"></span>
                    </td>
                    <td th:text="${incidencia.usuarioId}"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <button class="btn btn-danger mt-3" onclick="generarPDF()">Descargar PDF</button>
    <a th:href="@{/}" class="btn btn-secondary mt-3">Volver al inicio</a>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script th:inline="none">
    function generarPDF() {
        const doc = new window.jspdf.jsPDF('p', 'mm', 'a4');
        doc.setFontSize(18);
        doc.text('Reporte de Incidencias', 105, 15, { align: 'center' });

        const fecha = new Date().toLocaleDateString();
        doc.setFontSize(10);
        doc.text('Fecha de generación: ' + fecha, 14, 25);

        const rows = [];
        document.querySelectorAll('#reporte-content tbody tr').forEach(tr => {
            const row = [];
            tr.querySelectorAll('td').forEach(td => row.push(td.innerText));
            rows.push(row);
        });

        const headers = [['ID', 'Descripción', 'Estado Equipo', 'Nombre Equipo', 'Tipo', 'Ubicación', 'Fecha Apertura', 'Fecha Cierre', 'Usuario ID']];

        doc.autoTable({
            head: headers,
            body: rows,
            startY: 30,
            styles: { fontSize: 10 },
            headStyles: { fillColor: [52, 58, 64] },
            alternateRowStyles: { fillColor: [240, 240, 240] }
        });

        doc.save('reporte_incidencias.pdf');
    }
</script>
</body>
</html>